<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archaeological Site Extractor</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>Archaeological Site Extraction Tool</h1>
        <p class="subtitle">Upload a PDF to extract archaeological site information</p>
        
        <!-- Upload Section -->
        <div class="upload-section">
            <form id="uploadForm">
                <div class="file-input-wrapper">
                    <input type="file" id="pdfFile" name="pdf_file" accept=".pdf" required>
                    <label for="pdfFile" id="fileLabel">Choose PDF file...</label>
                </div>
                <button type="submit" id="submitBtn">Extract Sites</button>
            </form>
        </div>

        <!-- Status Section -->
        <div id="statusSection" class="status-section" style="display: none;">
            <div class="loader"></div>
            <p id="statusText">Processing PDF...</p>
        </div>

        <!-- Error Section -->
        <div id="errorSection" class="error-section" style="display: none;">
            <h3>Error</h3>
            <p id="errorText"></p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="results-section" style="display: none;">
            <div class="results-header">
                <h2>Extraction Results</h2>
                <button id="downloadBtn" class="download-btn">Download JSON</button>
            </div>

            <!-- Summary -->
            <div class="summary">
                <h3>Summary</h3>
                <div id="summaryContent"></div>
            </div>

            <!-- Sites List -->
            <div class="sites-list">
                <h3>Sites Found</h3>
                <div id="sitesContent"></div>
            </div>
        </div>
    </div>

    <script>
        let extractedData = null;

        // File input label update
        document.getElementById('pdfFile').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || 'Choose PDF file...';
            document.getElementById('fileLabel').textContent = fileName;
        });

        // Form submission
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('pdfFile');
            if (!fileInput.files[0]) {
                alert('Please select a PDF file');
                return;
            }

            // Hide previous results/errors
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            
            // Show loading
            document.getElementById('statusSection').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;

            // Prepare form data
            const formData = new FormData();
            formData.append('pdf_file', fileInput.files[0]);

            try {
                const response = await fetch('/extract', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                // Hide loading
                document.getElementById('statusSection').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;

                if (result.error) {
                    showError(result.error);
                } else {
                    extractedData = result.data;
                    displayResults(result.data);
                }

            } catch (error) {
                document.getElementById('statusSection').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
                showError('Network error: ' + error.message);
            }
        });

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorSection').style.display = 'block';
        }

        function displayResults(data) {
            // Display summary
            const summary = data.extraction_summary || {};
            const summaryHTML = `
                <p><strong>Total Sites Found:</strong> ${summary.total_sites_found || 0}</p>
                <p><strong>Sites with Coordinates:</strong> ${summary.sites_with_explicit_coordinates || 0}</p>
                <p><strong>Sites with Descriptions Only:</strong> ${summary.sites_with_descriptions_only || 0}</p>
            `;
            document.getElementById('summaryContent').innerHTML = summaryHTML;

            // Display sites
            const sites = data.sites || [];
            let sitesHTML = '';

            if (sites.length === 0) {
                sitesHTML = '<p>No sites found in the document.</p>';
            } else {
                sites.forEach((site, index) => {
                    sitesHTML += createSiteCard(site, index);
                });
            }

            document.getElementById('sitesContent').innerHTML = sitesHTML;
            document.getElementById('resultsSection').style.display = 'block';

            // Attach event listeners to download buttons
            attachDownloadListeners();
        }

        function createSiteCard(site, index) {
            const hasCoordinates = site.coordinates?.has_explicit_coordinates || false;
            const coordinatesRaw = site.coordinates?.raw_text || '';
            const siteName = site.site_name || 'Unnamed Site';
            
            let html = `
                <div class="site-card">
                    <div class="site-header">
                        <h4>Site ${index + 1}: ${siteName}</h4>
                        ${hasCoordinates ? `
                            <button class="gee-download-btn" 
                                    data-site-name="${siteName}"
                                    data-coordinates="${coordinatesRaw}"
                                    data-index="${index}">
                                ðŸ“¥ Download GEE Data
                            </button>
                        ` : ''}
                    </div>
                    
                    ${site.site_code ? `<p><strong>Code:</strong> ${site.site_code}</p>` : ''}
                    
                    ${hasCoordinates ? `
                        <div class="coordinates">
                            <strong>Coordinates:</strong> ${coordinatesRaw}
                            ${site.coordinates.format ? ` (${site.coordinates.format})` : ''}
                            ${site.coordinates.datum ? ` [${site.coordinates.datum}]` : ''}
                        </div>
                    ` : ''}
                    
                    ${site.location_description ? `
                        <p><strong>Location:</strong> ${site.location_description}</p>
                    ` : ''}
                    
                    ${site.administrative_location?.country ? `
                        <p><strong>Country:</strong> ${site.administrative_location.country}</p>
                    ` : ''}
                    
                    ${site.temporal?.dating ? `
                        <p><strong>Dating:</strong> ${site.temporal.dating}</p>
                    ` : ''}
                    
                    ${site.characteristics?.site_type ? `
                        <p><strong>Type:</strong> ${site.characteristics.site_type}</p>
                    ` : ''}
                    
                    ${site.metadata?.confidence_level ? `
                        <p class="confidence"><strong>Confidence:</strong> ${site.metadata.confidence_level}</p>
                    ` : ''}
                </div>
            `;
            
            return html;
        }

        function attachDownloadListeners() {
            const downloadButtons = document.querySelectorAll('.gee-download-btn');
            
            downloadButtons.forEach(button => {
                button.addEventListener('click', async function() {
                    const siteName = this.getAttribute('data-site-name');
                    const coordinatesRaw = this.getAttribute('data-coordinates');
                    
                    await downloadGEEData(siteName, coordinatesRaw, this);
                });
            });
        }

        async function downloadGEEData(siteName, coordinatesRaw, buttonElement) {
            // Disable button and show loading
            const originalText = buttonElement.textContent;
            buttonElement.disabled = true;
            buttonElement.textContent = 'â³ Extracting...';
            
            try {
                const response = await fetch('/download_gee', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        site_name: siteName,
                        coordinates_raw: coordinatesRaw
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Download failed');
                }

                // Get the blob and create download link
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // Extract filename from Content-Disposition header or use default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `${siteName.replace(/[^a-z0-9]/gi, '_')}_gee_data.zip`;
                
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // Success feedback
                buttonElement.textContent = 'âœ… Downloaded!';
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.disabled = false;
                }, 3000);

            } catch (error) {
                console.error('GEE download error:', error);
                alert('Failed to download GEE data: ' + error.message);
                
                buttonElement.textContent = 'âŒ Failed';
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.disabled = false;
                }, 3000);
            }
        }

        // Download JSON
        document.getElementById('downloadBtn').addEventListener('click', function() {
            if (!extractedData) return;

            const dataStr = JSON.stringify(extractedData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'extracted_sites.json';
            link.click();
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>